<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gesti√≥n de Campa√±a</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
            text-transform: uppercase;
        }

        .mode-view {
            background: #17a2b8;
            color: white;
        }

        .mode-edit {
            background: #ffc107;
            color: #000;
        }

        .header h1::before {
            content: "üìù";
            font-size: 1.2em;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-secondary::before {
            content: "‚Üê";
        }

        .form-container {
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .form-section {
            padding: 25px;
            border-bottom: 1px solid #404040;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #ffffff;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #404040;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #333333;
            color: #ffffff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Estilos para modo solo lectura */
        input[readonly], select[disabled], textarea[readonly] {
            background-color: #1a1a1a;
            border-color: #333333;
            cursor: default;
            color: #cccccc;
        }

        select:disabled {
            opacity: 1;
        }

        .loading-text {
            color: #666;
            font-style: italic;
            font-size: 12px;
            margin-top: 5px;
        }

        .error-text {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .success-text {
            color: #28a745;
            font-size: 12px;
            margin-top: 5px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .segmentos-container {
            background: #333333;
            color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .segmentos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-add-segment {
            background: #4a9eff;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .btn-add-segment:hover {
            background: #3590ff;
        }

        .btn-add-segment::before {
            content: "‚ûï";
        }

        .btn-add-segment:disabled {
            background: #555555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .segmento-item {
            background: #2a2a2a;
            border: 2px solid #404040;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .segmento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .segmento-title {
            font-weight: 600;
            color: #ffffff;
        }

        .btn-remove-segment {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .btn-remove-segment:hover {
            background: #c82333;
        }

        .btn-remove-segment:disabled {
            display: none;
        }

        .empty-segments {
            text-align: center;
            color: #cccccc;
            padding: 30px;
            border: 2px dashed #404040;
            border-radius: 8px;
        }

        .empty-segments::before {
            content: "üéØ";
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 25px;
            background: #2a2a2a;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-primary::before {
            content: "üíæ";
        }

        .btn-edit {
            background: #ffc107;
            color: #000;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-edit::before {
            content: "‚úèÔ∏è";
        }

        .btn-cancel {
            background: #4b4b4b;
            color: #ffffff;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-cancel:hover {
            border-color: #4b6b86;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: #2a2a2a;
            color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        .error-message {
            background: #dc3545;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #28a745;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        /* Ocultar elementos en modo vista */
        .view-mode-hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
            }

            .segmentos-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
        }
    
/* Estilos para interruptor Activo/Inactivo */
.switch-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}
.switch-label {
    display: inline-flex;
    align-items: center;
    gap: .6rem;
    cursor: pointer;
    user-select: none;
    font-family: system-ui, sans-serif;
    font-size: 16px;
}
.slider {
    width: 42px;
    height: 24px;
    border-radius: 999px;
    background: #c7c7c7;
    position: relative;
    transition: background .2s ease;
}
.slider::after {
    content: "";
    position: absolute;
    top: 2px; left: 2px;
    width: 20px; height: 20px;
    border-radius: 50%;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,.25);
    transition: transform .2s ease;
}
.switch-input:checked + .switch-label .slider {
    background: #22c55e;
}
.switch-input:checked + .switch-label .slider::after {
    transform: translateX(18px);
}
.state::after { content: "Inactivo"; }
.switch-input:checked + .switch-label .state::after { content: "Activo"; }
</style>
</head>
<body>
    <div class="container">
    <div class="header">
    <h1>
    <span id="page-title">Nueva Campa√±a</span>
    <span class="mode-badge" id="mode-badge" style="display: none;"></span>
    </h1>
    <a class="btn-secondary" href="campanas.html">Volver al Dashboard</a>
    </div>
    <form class="form-container" id="campaign-form">
    <div class="error-message" id="error-message"></div>
    <div class="success-message" id="success-message"></div>
    <!-- Secci√≥n: Datos de la Campa√±a -->
    <div class="form-section"><div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
    <h2 class="section-title">Datos de la Campa√±a</h2>
    <div class="switch-container">
    <input aria-checked="false" class="switch-input" id="activo" role="switch" type="checkbox"/>
    <label class="switch-label" for="activo">
    <span aria-hidden="true" class="slider"></span>
    <span class="state"></span>
    </label>
    <script>
    const sw = document.getElementById('activo');
    const sync = () => sw.setAttribute('aria-checked', String(sw.checked));
    sw.addEventListener('change', sync); sync();
    </script>
    </div></div>

<div class="form-grid">
<div class="form-group">
<label for="nombre">Nombre de la Campa√±a *</label>
<input id="nombre" name="nombre" required="" type="text"/>
</div>
<div class="form-group">
<label for="cliente">Cliente *</label>
<select id="cliente" name="cliente" required="">
<option value="">Seleccionar cliente</option>
<option value="Adara Group">Adara Group</option>
<option value="Dalio LevelUp">Dalio LevelUp</option>
<option value="DLM Grupo Legal">DLM Grupo Legal</option>
<option value="Esencial Staff">Esencial Staff</option>
<option value="FiraOnLive">FiraOnLive</option>
<option value="First Plug Ezequiel">First Plug Ezequiel</option>
<option value="FirstPlug Martin">FirstPlug Martin</option>
<option value="FirstPlug Matias">FirstPlug Matias</option>
<option value="FirstPlug Santiago">FirstPlug Santiago</option>
<option value="Hire Clinch">Hire Clinch</option>
<option value="LevelUp">LevelUp</option>
<option value="Konexo">Konexo</option>
<option value="LevelUp Federico">LevelUp Federico</option>
<option value="LevelUP Fran">LevelUP Fran</option>
<option value="LevelUP Guido">LevelUP Guido</option>
<option value="LevelUp Melany">LevelUp Melany</option>
<option value="LevelUP Sher">LevelUP Sher</option>
<option value="Lizarazo y Alvarez">Lizarazo y Alvarez</option>
<option value="Logyser">Logyser</option>
<option value="MetroRealty">MetroRealty</option>
<option value="P7">P7</option>
<option value="ProGaming">ProGaming</option>
<option value="Recinto Protegido">Recinto Protegido</option>
<option value="Romeo Sports">Romeo Sports</option>
<option value="Safety Mantis">Safety Mantis</option>
<option value="Visualogica">Visualogica</option>
</select>
</div>
<div class="form-group">
<label for="fecha-alta">Fecha de Alta *</label>
<input id="fecha-alta" name="fechaAlta" required="" type="date"/>
</div>
<div class="form-group">
<label for="objetivo">Objetivo Comercial</label>
<select id="objetivo" name="objetivoComercial">
<option value="">Seleccionar objetivo</option>
<option value="Aumentar ventas">Aumentar ventas</option>
<option value="Generar leads">Generar leads</option>
<option value="Brand awareness">Brand awareness</option>
<option value="Retenci√≥n de clientes">Retenci√≥n de clientes</option>
<option value="Lanzamiento de producto">Lanzamiento de producto</option>
</select>
</div>
<div class="form-group full-width">
<label for="observaciones">Descripci√≥n</label>
<textarea id="observaciones" name="observaciones" placeholder="Describe cualquier informaci√≥n adicional sobre la campa√±a..."></textarea>
</div>
</div>
</div>
<!-- Secci√≥n: Segmentos -->
<div class="form-section">
<h2 class="section-title">
                    Segmentos de la Campa√±a
                </h2>
<div class="segmentos-container">
<div class="segmentos-header">
<div>
<strong>Segmentos configurados: <span id="segmentos-count">0</span></strong>
<p id="segmentos-subtitle" style="font-size: 14px; color: #cccccc; margin-top: 5px;">
                                Agreg√° los segmentos que formar√°n parte de esta campa√±a
                            </p>
</div>
<button class="btn-add-segment" id="btn-add-segment" onclick="agregarSegmento()" type="button">
                            Agregar Segmento
                        </button>
</div>
<div id="segmentos-list">
<div class="empty-segments">
<h4>No hay segmentos agregados</h4>
<p id="empty-segments-text">Comenz√° agregando el primer segmento de tu campa√±a</p>
</div>
</div>
</div>
</div>
<!-- Acciones -->
<div class="actions" id="actions-section">
<a class="btn-cancel" href="campanas.html">Volver</a>
<button class="btn-primary btn-edit" id="edit-btn" onclick="habilitarEdicion()" style="display: none;" type="button">
                    Editar Campa√±a
                </button>
<button class="btn-primary" id="submit-btn" type="submit">
                    Guardar Campa√±a
                </button>
</div>
</form>
</div>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
<div class="loading-content">
<h3 id="loading-text">Procesando...</h3>
<p>Por favor, espera un momento</p>
</div>
</div>
<script>
        // Configuraci√≥n de URLs
        const CAMPAIGNS_WEBHOOK_URL = 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-get-sermentos';
        const SAVE_CAMPAIGN_URL = 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-save';
        const GET_CAMPAIGN_BY_ID_URL = 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-get-campaign-with-id';
        const UPDATE_CAMPAIGN_URL = 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-edit-campaign';
        
        // Variables globales
        let segmentos = [];
        let segmentoCounter = 0;
        let segmentosData = [];
        let modoActual = 'create'; // create, view, edit
        let campanaId = null;
        let campanaData = null;

        // Inicializar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener par√°metros de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const id = urlParams.get('id');
            
            console.log('Par√°metros URL:', { mode, id });
            debugger
            if (mode && id) {
                campanaId = id;
                modoActual = mode;
                configurarModo(mode);
                cargarDatosCampana(id);
            } else {
                // Modo crear por defecto
                modoActual = 'create';
                document.getElementById('fecha-alta').value = new Date().toISOString().split('T')[0];
            }
        });

        // Funci√≥n para configurar el modo de la p√°gina
        function configurarModo(mode) {
            const pageTitle = document.getElementById('page-title');
            const modeBadge = document.getElementById('mode-badge');
            const submitBtn = document.getElementById('submit-btn');
            const editBtn = document.getElementById('edit-btn');
            const addSegmentBtn = document.getElementById('btn-add-segment');
            const segmentosSubtitle = document.getElementById('segmentos-subtitle');
            const emptySegmentsText = document.getElementById('empty-segments-text');
            
            console.log('Configurando modo:', mode);
            
            if (mode === 'view') {
                pageTitle.textContent = 'Ver Campa√±a';
                modeBadge.textContent = 'SOLO LECTURA';
                modeBadge.className = 'mode-badge mode-view';
                modeBadge.style.display = 'inline-block';
                
                // Ocultar bot√≥n de guardar y mostrar bot√≥n de editar
                submitBtn.style.display = 'none';
                editBtn.style.display = 'flex';
                
                // Deshabilitar bot√≥n de agregar segmento
                addSegmentBtn.disabled = true;
                
                // Cambiar textos
                segmentosSubtitle.textContent = 'Segmentos configurados en esta campa√±a';
                emptySegmentsText.textContent = 'Esta campa√±a no tiene segmentos configurados';
                
                // Hacer todos los campos solo lectura
                setTimeout(() => hacerCamposSoloLectura(true), 100);
                
            } else if (mode === 'edit') {
                pageTitle.textContent = 'Editar Campa√±a';
                modeBadge.textContent = 'MODO EDICI√ìN';
                modeBadge.className = 'mode-badge mode-edit';
                modeBadge.style.display = 'inline-block';
                
                submitBtn.textContent = 'Actualizar Campa√±a';
                submitBtn.style.display = 'flex';
                editBtn.style.display = 'none';
                addSegmentBtn.disabled = false;
                
                // Hacer campos editables
                hacerCamposSoloLectura(false);
            }
        }

        // Funci√≥n para hacer los campos solo lectura
        function hacerCamposSoloLectura(soloLectura) {
            const inputs = document.querySelectorAll('input:not([type="button"]):not([type="submit"])');
            const selects = document.querySelectorAll('select');
            const textareas = document.querySelectorAll('textarea');
            document.getElementById('activo').disabled = soloLectura;
            inputs.forEach(input => {
                input.readOnly = soloLectura;
            });
            
            selects.forEach(select => {
                select.disabled = soloLectura;
            });
            
            textareas.forEach(textarea => {
                textarea.readOnly = soloLectura;
            });
            
            // Manejar botones de eliminar segmento
            document.querySelectorAll('.btn-remove-segment').forEach(btn => {
                if (soloLectura) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'block';
                }
            });
        }

        // Funci√≥n para cargar datos de la campa√±a
        async function cargarDatosCampana(id) {
            mostrarLoading(true, 'Cargando datos de la campa√±a...');
            
            try {
                // Intentar cargar desde el servidor
                
                const response = await fetch(GET_CAMPAIGN_BY_ID_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id })
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar la campa√±a');
                }
                
                campanaData = await response.json();
               
                
                // DATOS DE PRUEBA (eliminar cuando el webhook est√© listo)
/*                 campanaData = {
                    id: id,
                    nombre: 'Campa√±a de Ejemplo ' + id,
                    cliente: 'LevelUp',
                    fechaAlta: '2024-01-15',
                    objetivoComercial: 'Generar leads',
                    observaciones: 'Esta es una campa√±a de prueba para demostrar la funcionalidad de visualizaci√≥n y edici√≥n',
                    segmentos: [
                        {
                            id: 'SEG001',
                            fechaAlta: '2024-01-15',
                            descripcion: 'Segmento de empresas tecnol√≥gicas',
                            industria: 'Tecnolog√≠a\nSoftware\nConsultor√≠a IT',
                            empleados: '50-200',
                            responsabilidad: 'Decisi√≥n de compra\nEvaluaci√≥n t√©cnica',
                            cargo: 'CTO\nDirector de TI\nGerente de Sistemas',
                            funcion: 'Tecnolog√≠a\nInnovaci√≥n',
                            area: 'IT\nDesarrollo',
                            ubicacion: 'Buenos Aires\nC√≥rdoba'
                        },
                        {
                            id: 'SEG002',
                            fechaAlta: '2024-01-16',
                            descripcion: 'Segmento de startups',
                            industria: 'Fintech\nE-commerce',
                            empleados: '10-50',
                            responsabilidad: 'Estrategia\nCrecimiento',
                            cargo: 'CEO\nCOO',
                            funcion: 'Direcci√≥n',
                            area: 'Management',
                            ubicacion: 'CABA'
                        }
                    ]
                };
                 */
                console.log('Datos de campa√±a cargados:', campanaData);
                
                // Cargar datos en el formulario
                cargarDatosEnFormulario(campanaData[0]);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al cargar los datos de la campa√±a. Usando datos de ejemplo.');
            } finally {
                mostrarLoading(false);
            }
        }

        // Funci√≥n para cargar los datos en el formulario
        function cargarDatosEnFormulario(data) {
            // Cargar datos b√°sicos
            document.getElementById('nombre').value = data.nombre || '';
            document.getElementById('cliente').value = data.cliente || '';
            document.getElementById('fecha-alta').value = data.fechaAlta.split("T")[0] || '';
            document.getElementById('objetivo').value = data.objetivoComercial || data.objetivo_comercial || '';
            document.getElementById('observaciones').value = data.observaciones_iniciales || '';
            const switchElement = document.getElementById('activo');
            switchElement.checked = data.estado == "Inactivo"? false : true;
            switchElement.setAttribute('aria-checked', data.estado == "Inactivo"? "false" : "true");
            // Cargar segmentos
            if (data.segmentos && data.segmentos.length > 0) {
                // Limpiar lista de segmentos
                document.getElementById('segmentos-list').innerHTML = '';
                segmentoCounter = 0;
                
                // Agregar cada segmento
                data.segmentos.forEach(segmento => {
                    agregarSegmentoConDatos(segmento);
                });
            }
            
            // Aplicar modo de solo lectura si es necesario
            if (modoActual === 'view') {
                setTimeout(() => hacerCamposSoloLectura(true), 100);
            }
        }

        // Funci√≥n para agregar un segmento con datos precargados
        function agregarSegmentoConDatos(segmentoData) {
            segmentoCounter++;
            const segmentoId = `segmento-${segmentoCounter}`;
            const isViewMode = modoActual === 'view';
            
            const segmentoHtml = `
                <div class="segmento-item" id="${segmentoId}">
                    <div class="segmento-header">
                        <span class="segmento-title">Segmento ${segmentoCounter}</span>
                        <button type="button" class="btn-remove-segment" onclick="eliminarSegmento('${segmentoId}')" ${isViewMode ? 'style="display:none;"' : ''}>
                            ‚úï Eliminar
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ID de Segmento</label>
                            <input type="text" name="segmento-id-${segmentoCounter}" 
                                   value="${segmentoData.id || ''}" ${isViewMode ? 'readonly' : ''}>
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Alta del Segmento</label>
                            <input type="date" name="segmento-fecha-${segmentoCounter}" 
                                   value="${segmentoData.fechaAlta || new Date().toISOString().split('T')[0]}" 
                                   ${isViewMode ? 'readonly' : ''}>
                        </div>

                        <div class="form-group full-width">
                            <label>Descripci√≥n</label>
                            <textarea name="segmento-descripcion-${segmentoCounter}" rows="3" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.descripcion || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Industria</label>
                            <textarea name="segmento-industria-${segmentoCounter}" rows="4" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.industria || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Cantidad Empleados</label>
                            <textarea name="segmento-empleados-${segmentoCounter}" rows="2" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.empleados || segmentoData.cantidad_empleados || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Responsabilidad</label>
                            <textarea name="segmento-responsabilidad-${segmentoCounter}" rows="4" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.responsabilidad || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Cargo</label>
                            <textarea name="segmento-cargo-${segmentoCounter}" rows="4" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.cargo || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Funci√≥n</label>
                            <textarea name="segmento-funcion-${segmentoCounter}" rows="3" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.funcion || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>√Årea</label>
                            <textarea name="segmento-area-${segmentoCounter}" rows="3" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.area || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Ubicaci√≥n Sede</label>
                            <textarea name="segmento-ubicacion-${segmentoCounter}" rows="3" 
                                      ${isViewMode ? 'readonly' : ''}>${segmentoData.ubicacion || segmentoData.ubicacion_sede || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar el segmento
            document.getElementById('segmentos-list').insertAdjacentHTML('beforeend', segmentoHtml);
            
            // Actualizar contador
            actualizarContadorSegmentos();
        }

        // Funci√≥n para habilitar edici√≥n (cambiar de modo vista a modo edici√≥n)
        function habilitarEdicion() {
            modoActual = 'edit';
            configurarModo('edit');
            
            // URL sin recargar la p√°gina
            const newUrl = `${window.location.pathname}?mode=edit&id=${campanaId}`;
            window.history.pushState({ mode: 'edit', id: campanaId }, '', newUrl);
        }

        // Funci√≥n para agregar un nuevo segmento
        function agregarSegmento() {
            if (modoActual === 'view') return;
            
            segmentoCounter++;
            const segmentoId = `segmento-${segmentoCounter}`;
            
            const segmentoHtml = `
                <div class="segmento-item" id="${segmentoId}">
                    <div class="segmento-header">
                        <span class="segmento-title">Segmento ${segmentoCounter}</span>
                        <button type="button" class="btn-remove-segment" onclick="eliminarSegmento('${segmentoId}')">
                            ‚úï Eliminar
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ID de Segmento</label>
                            <select id="segmento-id-${segmentoCounter}" name="segmento-id-${segmentoCounter}" disabled onchange="cargarDatosDelSegmento(${segmentoCounter}, this.value)">
                                <option value="">Cargando segmentos...</option>
                            </select>
                            <div id="segmento-id-status-${segmentoCounter}" class="loading-text">Obteniendo lista de segmentos...</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Alta del Segmento</label>
                            <input type="date" name="segmento-fecha-${segmentoCounter}" value="${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div class="form-group full-width">
                            <label>Descripci√≥n</label>
                            <textarea name="segmento-descripcion-${segmentoCounter}" placeholder="Descripci√≥n del segmento" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Industria</label>
                            <textarea name="segmento-industria-${segmentoCounter}" placeholder=" " rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Cantidad Empleados</label>
                            <textarea name="segmento-empleados-${segmentoCounter}" placeholder=" " rows="2"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Responsabilidad</label>
                            <textarea name="segmento-responsabilidad-${segmentoCounter}" placeholder=" " rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Cargo</label>
                            <textarea name="segmento-cargo-${segmentoCounter}" placeholder=" " rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Funci√≥n</label>
                            <textarea name="segmento-funcion-${segmentoCounter}" placeholder=" " rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>√Årea</label>
                            <textarea name="segmento-area-${segmentoCounter}" placeholder=" " rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Ubicaci√≥n Sede</label>
                            <textarea name="segmento-ubicacion-${segmentoCounter}" placeholder=" " rows="3"></textarea>
                        </div>

                    </div>
                </div>
            `;
            
            // Remover empty state si existe
            const emptyState = document.querySelector('.empty-segments');
            if (emptyState) {
                emptyState.remove();
            }
            
            // Agregar el nuevo segmento
            document.getElementById('segmentos-list').insertAdjacentHTML('beforeend', segmentoHtml);
            
            // Cargar solo los datos para el ID de Segmento
            cargarSegmentoIds(segmentoCounter);
            
            // Actualizar contador
            actualizarContadorSegmentos();
        }

         function formatearFecha(fecha) {
            debugger;
            
            const date = new Date(fecha);
            return date.toLocaleDateString('es-AR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        // Funci√≥n para cargar solo los IDs de segmento
        async function cargarSegmentoIds(segmentoNumber) {
            const selectId = `segmento-id-${segmentoNumber}`;
            const statusId = `segmento-id-status-${segmentoNumber}`;
            const select = document.getElementById(selectId);
            const statusDiv = document.getElementById(statusId);
            
            try {
                statusDiv.textContent = 'Obteniendo lista de segmentos...';
                statusDiv.className = 'loading-text';
                
                const miVariable = document.getElementById('cliente').value;

                const response = await fetch(CAMPAIGNS_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        variable: miVariable
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos de segmentos recibidos:', data);
                
                // Procesar los datos
                let segmentos = [];
                
                if (Array.isArray(data)) {
                    segmentos = data;
                } else if (data.segmentos && Array.isArray(data.segmentos)) {
                    segmentos = data.segmentos;
                } else if (data.data && Array.isArray(data.data)) {
                    segmentos = data.data;
                } else if (data.results && Array.isArray(data.results)) {
                    segmentos = data.results;
                } else {
                    segmentos = Object.values(data);
                }
                
                // Guardar los datos completos para uso posterior
                segmentosData = segmentos;
                
                // Limpiar el select
                select.innerHTML = '';
                
                // Agregar opci√≥n por defecto
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecciona un segmento';
                select.appendChild(defaultOption);
                
                if (segmentos.length === 0) {
                    throw new Error('No se encontraron segmentos');
                }
                
                // Agregar cada segmento como opci√≥n
                segmentos.forEach((segmento, index) => {
                    const option = document.createElement('option');
                    option.value = segmento.id || segmento._id || segmento.key || index;
                    option.textContent = segmento.nombresegmento;
                    select.appendChild(option);
                });
                
                // Habilitar el select y actualizar status
                select.disabled = false;
                statusDiv.textContent = `${segmentos.length} segmentos cargados`;
                statusDiv.className = 'success-text';
                
                // Ocultar el mensaje despu√©s de 3 segundos
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error al cargar segmentos:', error);
                
                select.innerHTML = '';
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'Error al cargar segmentos';
                select.appendChild(errorOption);
                
                const manualOption = document.createElement('option');
                manualOption.value = 'manual';
                manualOption.textContent = 'Ingresar manualmente';
                select.appendChild(manualOption);
                
                select.disabled = false;
                statusDiv.textContent = 'Error al cargar. Selecciona "Ingresar manualmente"';
                statusDiv.className = 'error-text';
                
                // Permitir entrada manual
                select.addEventListener('change', function() {
                    if (this.value === 'manual') {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = selectId;
                        input.name = select.name;
                        input.placeholder = 'Ej: SEG001';
                        input.style.padding = '12px';
                        input.style.border = '2px solid #404040';
                        input.style.borderRadius = '6px';
                        input.style.fontSize = '14px';
                        input.style.background = '#333333';
                        input.style.color = '#ffffff';
                        
                        this.parentNode.replaceChild(input, this);
                        statusDiv.textContent = 'Entrada manual habilitada';
                        statusDiv.className = 'loading-text';
                        input.focus();
                    }
                });
            }
        }

        // Funci√≥n para cargar los datos de un segmento espec√≠fico en los campos
        function cargarDatosDelSegmento(segmentoNumber, selectedId) {
            if (!selectedId || selectedId === 'manual') return;
            
            // Buscar el segmento seleccionado en los datos
            const segmentoSeleccionado = segmentosData.find(seg => 
                (seg.id == selectedId)
            );
            
            if (!segmentoSeleccionado) {
                console.log('No se encontraron datos para el segmento:', selectedId);
                return;
            }
            
            console.log('Datos del segmento seleccionado:', segmentoSeleccionado);
            
            // Funci√≥n para procesar datos JSON string
            function procesarDatoJSON(valor) {
                if (!valor) return '';
                try {
                    if (typeof valor === 'string' && valor.startsWith('{')) {
                        const parsed = JSON.parse(valor);
                        // Extraer solo los valores que no empiecen con "Excluir"
                        const valores = Object.keys(parsed).filter(key => !key.startsWith('Excluir'));
                        return valores.length > 0 ? valores.join('\n') : '';
                    }
                    return valor;
                } catch (e) {
                    return valor;
                }
            }
            
            // Mapear los campos con los nombres correctos de la respuesta
            const campos = {
                'descripcion': segmentoSeleccionado.descripcion || '',
                'industria': procesarDatoJSON(segmentoSeleccionado.industria),
                'empleados': segmentoSeleccionado.cantidad_empleados || '',
                'responsabilidad': procesarDatoJSON(segmentoSeleccionado.responsabilidad),
                'cargo': procesarDatoJSON(segmentoSeleccionado.cargo),
                'funcion': procesarDatoJSON(segmentoSeleccionado.funcion),
                'area': procesarDatoJSON(segmentoSeleccionado.area),
                'ubicacion': procesarDatoJSON(segmentoSeleccionado.ubicacion_sede)
            };
            
            console.log('Campos procesados:', campos);
            
            // Aplicar los valores a los textareas
            Object.keys(campos).forEach(campo => {
                const textarea = document.querySelector(`textarea[name="segmento-${campo}-${segmentoNumber}"]`);
                if (textarea) {
                    textarea.value = campos[campo];
                    console.log(`Campo ${campo} actualizado con:`, campos[campo]);
                }
            });
        }

        // Funci√≥n para eliminar un segmento
        function eliminarSegmento(segmentoId) {
            if (modoActual === 'view') return;
            
            if (confirm('¬øEst√°s seguro de que quer√©s eliminar este segmento?')) {
                document.getElementById(segmentoId).remove();
                actualizarContadorSegmentos();
                
                // Si no quedan segmentos, mostrar empty state
                const segmentosList = document.getElementById('segmentos-list');
                if (segmentosList.children.length === 0) {
                    const emptyText = modoActual === 'view' 
                        ? 'Esta campa√±a no tiene segmentos configurados'
                        : 'Comenz√° agregando el primer segmento de tu campa√±a';
                    
                    segmentosList.innerHTML = `
                        <div class="empty-segments">
                            <h4>No hay segmentos agregados</h4>
                            <p>${emptyText}</p>
                        </div>
                    `;
                }
            }
        }

        // Funci√≥n para actualizar el contador de segmentos
        function actualizarContadorSegmentos() {
            const count = document.querySelectorAll('.segmento-item').length;
            document.getElementById('segmentos-count').textContent = count;
        }

        // Funci√≥n para manejar el env√≠o del formulario
        document.getElementById('campaign-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validarFormulario()) {
                return;
            }
            
            const campaignData = recopilarDatosCampana();
            
            if (modoActual === 'edit' && campanaId) {
                campaignData.id = campanaId;
                await actualizarCampana(campaignData);
            } else {
                await guardarCampana(campaignData);
            }
        });

        // Funci√≥n para validar el formulario
        function validarFormulario() {
            const nombreElement = document.getElementById('nombre');
            const nombreValue = nombreElement.value ? nombreElement.value.trim() : '';
            const cliente = document.getElementById('cliente').value;
            const fechaAlta = document.getElementById('fecha-alta').value;
            
            if (!nombreValue || !cliente || !fechaAlta) {
                mostrarError('Por favor, complet√° todos los campos obligatorios.');
                return false;
            }
            
            const segmentosCount = document.querySelectorAll('.segmento-item').length;
            if (segmentosCount === 0) {
                mostrarError('Agreg√° al menos un segmento a la campa√±a.');
                return false;
            }
            
            return true;
        }

        // Funci√≥n para recopilar todos los datos de la campa√±a
        function recopilarDatosCampana() {
            const formData = new FormData(document.getElementById('campaign-form'));
            debugger;
            const campana = {
                nombre: document.getElementById('nombre').value,
                cliente: formData.get('cliente'),
                fechaAlta: formData.get('fechaAlta').split("T")[0],
                objetivoComercial: formData.get('objetivoComercial'),
                observaciones_iniciales: formData.get('observaciones'),
                estado: sw.ariaChecked == "true"? "Activo" : "Inactivo",
                fechaCreacion: campanaData?.fechaCreacion || new Date().toISOString(),
                segmentos: []
            };
            
            // Recopilar datos de segmentos
            const segmentoItems = document.querySelectorAll('.segmento-item');
            segmentoItems.forEach((item, index) => {
                const segmentoNum = item.id.split('-')[1];
                
                // Obtener el ID del segmento (puede ser select o input)
                let segmentoIdElement = document.getElementById(`segmento-id-${segmentoNum}`);
                let segmentoId = '';
                
                if (segmentoIdElement) {
                    segmentoId = segmentoIdElement.value;
                } else {
                    // Buscar por name en caso de que sea un input
                    segmentoIdElement = document.querySelector(`[name="segmento-id-${segmentoNum}"]`);
                    if (segmentoIdElement) {
                        segmentoId = segmentoIdElement.value;
                    }
                }

                const segmento = {
                    id: segmentoId || `SEG${String(index + 1).padStart(3, '0')}`,
                    fechaAlta: formData.get(`segmento-fecha-${segmentoNum}`),
                    descripcion: formData.get(`segmento-descripcion-${segmentoNum}`),
                    industria: formData.get(`segmento-industria-${segmentoNum}`),
                    empleados: formData.get(`segmento-empleados-${segmentoNum}`),
                    responsabilidad: formData.get(`segmento-responsabilidad-${segmentoNum}`),
                    cargo: formData.get(`segmento-cargo-${segmentoNum}`),
                    funcion: formData.get(`segmento-funcion-${segmentoNum}`),
                    area: formData.get(`segmento-area-${segmentoNum}`),
                    ubicacion: formData.get(`segmento-ubicacion-${segmentoNum}`)
                };
                campana.segmentos.push(segmento);
            });
            
            return campana;
        }

        // Funci√≥n para guardar la campa√±a (crear nueva)
        async function guardarCampana(campaignData) {
            mostrarLoading(true, 'Guardando campa√±a...');
            
            try {
                console.log('Datos a enviar:', campaignData);
                
                const response = await fetch(SAVE_CAMPAIGN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(campaignData)
                });
                
                if (!response.ok) {
                    throw new Error('Error al guardar la campa√±a');
                }
                
                mostrarExito('Campa√±a guardada exitosamente');
                
                // Redirigir al dashboard despu√©s de 2 segundos
                setTimeout(() => {
                    window.location.href = 'campanas.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al guardar la campa√±a. Intent√° nuevamente.');
            } finally {
                mostrarLoading(false);
            }
        }

        // Funci√≥n para actualizar la campa√±a (editar existente)
        async function actualizarCampana(campaignData) {
            mostrarLoading(true, 'Actualizando campa√±a...');
            
            try {
                console.log('Datos a actualizar:', campaignData);
                
                const response = await fetch(UPDATE_CAMPAIGN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(campaignData)
                });
                
                if (!response.ok) {
                    throw new Error('Error al actualizar la campa√±a');
                }
                
                mostrarExito('Campa√±a actualizada exitosamente');
                
                // Volver a modo vista despu√©s de 2 segundos
                setTimeout(() => {
                    window.location.href = `crearcampana.html?mode=view&id=${campanaId}`;
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al actualizar la campa√±a. Intent√° nuevamente.');
            } finally {
                mostrarLoading(false);
            }
        }

        // Funciones de UI
        function mostrarLoading(mostrar, mensaje = 'Procesando...') {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            
            if (mensaje) {
                loadingText.textContent = mensaje;
            }
            
            overlay.style.display = mostrar ? 'flex' : 'none';
            document.getElementById('submit-btn').disabled = mostrar;
        }

        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function mostrarExito(mensaje) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = mensaje;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
           </script>
</body>
</html>