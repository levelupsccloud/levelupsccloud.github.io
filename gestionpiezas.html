<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Piezas v6</title>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #7f8c8d;
            --text-muted: #cccccc;
            --border-color: #555555;
            --accent-blue: #3498db;
            --accent-green: #28a745;
            --accent-yellow: #ffc107;
            --accent-red: #dc3545;
            --accent-cyan: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .header-info h1 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }

        .header-info h1::before {
            content: "🧩";
            font-size: 1.3em;
        }

        .header-info p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .version-badge {
            background: var(--accent-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        /* Button Styles */
        .btn {
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
            padding: 12px 20px;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 12px 20px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
            padding: 12px 24px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: var(--accent-yellow);
            color: #212529;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-cancel {
            background: transparent;
            color: var(--text-secondary);
            padding: 12px 24px;
            border: 2px solid var(--border-color);
        }

        .btn-cancel:hover {
            border-color: #6c757d;
            color: #495057;
        }

        /* Loading and Status */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            z-index: 1000;
            min-width: 250px;
        }

        .status-loading { background: var(--accent-cyan); color: white; }
        .status-success { background: var(--accent-green); color: white; }
        .status-error { background: var(--accent-red); color: white; }

        /* Table Styles */
        .data-table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            background: #000;
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: #000;
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state::before {
            content: "📋";
            font-size: 4em;
            display: block;
            margin-bottom: 20px;
        }

        /* Form Styles */
        .form-modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            overflow: hidden;
            display: none;
            margin-bottom: 30px;
        }

        .form-modal.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-header {
            background: var(--bg-secondary);
            color: white;
            padding: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
        }

        .form-content {
            padding: 30px;
            background: var(--bg-secondary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-label.required::after {
            content: " *";
            color: var(--accent-red);
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Communication Block Styles */
        .communication-block {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
        }

        .communication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .communication-type {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .communication-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
        }

        /* File Upload Styles */
        .file-upload-zone {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-upload-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            color: var(--text-muted);
            background: var(--bg-primary);
        }

        .file-upload-label:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .file-list {
            margin-top: 12px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-item.existing {
            opacity: 0.7;
            border-left: 4px solid var(--accent-green);
        }

        .file-remove {
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Message Styles */
        .message {
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 25px 30px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .data-table {
                font-size: 13px;
            }

            .data-table th,
            .data-table td {
                padding: 12px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-info">
                <h1>
                    Gestión de Piezas 
                    <span class="version-badge">v6</span>
                </h1>
                <p id="campaign-display">Campaña: Cargando...</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <a href="campanas.html" class="btn btn-secondary">
                    ← Volver al Dashboard
                </a>
                <button class="btn btn-primary" onclick="PieceManager.showCreateForm()">
                    + Nueva Pieza
                </button>
            </div>
        </header>

        <!-- Pieces Table -->
        <div class="data-table-container">
            <div class="table-header">
                <span>Piezas de la Campaña</span>
                <span id="pieces-counter">0 piezas</span>
            </div>
            
            <div id="empty-state-display" class="empty-state">
                <h3>No hay piezas creadas</h3>
                <p>Comenzá creando la primera pieza para esta campaña</p>
            </div>

            <table id="pieces-table" class="data-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Asunto Principal</th>
                        <th>Comunicaciones</th>
                        <th>Archivos</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="pieces-tbody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>

        <!-- Form Modal -->
        <div id="piece-form-modal" class="form-modal">
            <div class="form-header">
                <span id="form-modal-title">Nueva Pieza</span>
                <button type="button" class="btn btn-danger" onclick="PieceManager.hideForm()" style="padding: 8px 12px;">
                    ✕
                </button>
            </div>

            <form id="piece-form">
                <div id="form-error-message" class="message message-error"></div>
                <div id="form-success-message" class="message message-success"></div>

                <div class="form-content">
                    <div class="form-grid">
                        <div class="form-group full-width" style="text-align: center;">
                            <label for="campaign-name-input" class="form-label required">Campaña</label>
                            <input type="text" id="campaign-name-input" name="campana" class="form-input" readonly style="text-align: center; font-weight: 600;">
                        </div>

                        <!-- Communications Section -->
                        <div class="form-group full-width">
                            <label class="form-label">Comunicaciones</label>
                            
                            <div class="communication-selector">
                                <select id="communication-type-selector" class="form-select" style="flex: 1;">
                                    <option value="">Seleccionar tipo de comunicación</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="1er Mail">1er Mail</option>
                                    <option value="2ndo Mail">2ndo Mail</option>
                                    <option value="LHLN1">LHLN1</option>
                                    <option value="LHLN2">LHLN2</option>
                                    <option value="LHLN3">LHLN3</option>
                                    <option value="LHLN4">LHLN4</option>
                                    <option value="LHLN5">LHLN5</option>
                                    <option value="LHLN6">LHLN6</option>
                                    <option value="LHLN7">LHLN7</option>
                                    <option value="LHLN8">LHLN8</option>
                                    <option value="LHLN9">LHLN9</option>
                                    <option value="LHLN10">LHLN10</option>
                                    <option value="LHLN11">LHLN11</option>
                                    <option value="LHLN12">LHLN12</option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="CommunicationManager.add()">
                                    Agregar
                                </button>
                            </div>
                            
                            <div id="communications-container">
                                <!-- Dynamic communications -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="PieceManager.hideForm()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success submit">
                        💾 Guardar Pieza
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator"></div>

    <script>
        // ============================================
        // CONFIGURATION & GLOBALS
        // ============================================
        
        const CONFIG = {
            webhooks: {
                savePiece: 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-save-pieces',
                editPiece: 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-edit-piece',
                saveFiles: 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-save-files',
                loadPieces: 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-load-pieces',
                loadPieceDetails: 'https://n8n.levelupsc.cloud/webhook/7519bb10-678f-4ad0-91ef-00d009bd8a54-load-piece-details'
            },
            communicationTypes: {
                linkedin: 'LinkedIn',
                email: ['1er Mail', '2ndo Mail'],
                lhln: ['LHLN1', 'LHLN2', 'LHLN3', 'LHLN4', 'LHLN5', 'LHLN6', 'LHLN7', 'LHLN8', 'LHLN9', 'LHLN10', 'LHLN11', 'LHLN12']
            }
        };

        const STATE = {
            pieces: [],
            communications: [],
            campaignId: null,
            campaignName: '',
            editingPieceId: null,
            communicationCounter: 0
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        const Utils = {
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-AR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },


            getFileExtension(file) {
                if (!file?.name) return '';
                const lastDot = file.name.lastIndexOf('.');
                return lastDot !== -1 ? file.name.substring(lastDot) : '';
            },

            sanitizeFileName(text) {
                if (!text) return 'sin_nombre';
                return text
                    .replace(/[^a-zA-Z0-9\u00C0-\u017F\s]/g, '')
                    .replace(/\s+/g, '_')
                    .toLowerCase()
                    .substring(0, 50);
            },

            isLinkedInCommunication(type) {
                return type === CONFIG.communicationTypes.linkedin;
            },

            isEmailCommunication(type) {
                return CONFIG.communicationTypes.email.includes(type);
            },

            isLHLNCommunication(type) {
                return CONFIG.communicationTypes.lhln.includes(type);
            }
        };

        // ============================================
        // API MANAGER
        // ============================================
        
        const ApiManager = {
            async makeRequest(url, options = {}) {
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API Request failed for ${url}:`, error);
                    throw error;
                }
            },

            async loadPieces() {
                return this.makeRequest(CONFIG.webhooks.loadPieces, {
                    body: JSON.stringify({
                        campaignId: STATE.campaignId,
                        campana: STATE.campaignName
                    })
                });
            },

            async loadPieceDetails(pieceId) {
                return this.makeRequest(CONFIG.webhooks.loadPieceDetails, {
                    body: JSON.stringify({
                        piezaId: pieceId,
                        campaignId: STATE.campaignId,
                        campana: STATE.campaignName
                    })
                });
            },

            async savePiece(pieceData) {
                return this.makeRequest(CONFIG.webhooks.savePiece, {
                    body: JSON.stringify({ pieza: pieceData })
                });
            },

            async editPiece(pieceData) {
                return this.makeRequest(CONFIG.webhooks.editPiece, {
                    body: JSON.stringify({ pieza: pieceData })
                });
            },

            async saveFiles(formData) {
                const response = await fetch(CONFIG.webhooks.saveFiles, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`File upload failed: ${response.status} - ${response.statusText}`);
                }

                return await response.json();
            }
        };

        // ============================================
        // STATUS MANAGER
        // ============================================
        
        const StatusManager = {
            show(message, type = 'loading') {
                const indicator = document.getElementById('status-indicator');
                indicator.textContent = message;
                indicator.className = `status-indicator status-${type}`;
                indicator.style.display = 'block';

                if (type !== 'loading') {
                    setTimeout(() => this.hide(), 5000);
                }
            },

            hide() {
                document.getElementById('status-indicator').style.display = 'none';
            },

            loading(message) {
                this.show(message, 'loading');
            },

            success(message) {
                this.show(message, 'success');
            },

            error(message) {
                this.show(message, 'error');
            }
        };

        // ============================================
        // MESSAGE MANAGER
        // ============================================
        
        const MessageManager = {
            showError(message) {
                const errorDiv = document.getElementById('form-error-message');
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                this.hideSuccess();
            },

            showSuccess(message) {
                const successDiv = document.getElementById('form-success-message');
                successDiv.textContent = message;
                successDiv.classList.add('show');
                this.hideError();
                
                setTimeout(() => this.hideSuccess(), 5000);
            },

            hideError() {
                document.getElementById('form-error-message').classList.remove('show');
            },

            hideSuccess() {
                document.getElementById('form-success-message').classList.remove('show');
            },

            hideAll() {
                this.hideError();
                this.hideSuccess();
            }
        };

        // ============================================
        // COMMUNICATION MANAGER
        // ============================================
        
        const CommunicationManager = {
            add() {
                const selector = document.getElementById('communication-type-selector');
                const type = selector.value;
                
                if (!type) {
                    alert('Selecciona un tipo de comunicación');
                    return;
                }
                
                if (STATE.communications.find(c => c.type === type)) {
                    alert('Ya existe una comunicación de este tipo');
                    return;
                }
                
                STATE.communicationCounter++;
                const id = `comm-${STATE.communicationCounter}`;
                
                const communication = {
                    id,
                    type,
                    counter: STATE.communicationCounter,
                    files: { brochures: [], flyers: [] }
                };
                
                STATE.communications.push(communication);
                this.render(communication);
                this.setupEventListeners(communication);
                
                selector.value = '';
            },

            remove(id) {
                const communication = STATE.communications.find(c => c.id === id);
                if (!communication) return;
                
                if (confirm(`¿Eliminar la comunicación ${communication.type}?`)) {
                    document.getElementById(id).remove();
                    STATE.communications = STATE.communications.filter(c => c.id !== id);
                }
            },

            clear() {
                document.getElementById('communications-container').innerHTML = '';
                STATE.communications = [];
                STATE.communicationCounter = 0;
            },

            render(communication) {
                const container = document.getElementById('communications-container');
                const html = Utils.isLinkedInCommunication(communication.type) 
                    ? this.renderLinkedIn(communication)
                    : this.renderEmail(communication);
                
                container.insertAdjacentHTML('beforeend', html);
            },

            renderLinkedIn(comm) {
                return `
                    <div class="communication-block" id="${comm.id}">
                        <div class="communication-header">
                            <span class="communication-type">${comm.type}</span>
                            <button type="button" class="btn btn-danger" onclick="CommunicationManager.remove('${comm.id}')" style="padding: 6px 12px; font-size: 12px;">
                                Eliminar
                            </button>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Primer Mensaje</label>
                                <textarea name="primer-mensaje-${comm.counter}" class="form-textarea" placeholder="Contenido del primer mensaje de LinkedIn"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Follow-up</label>
                                <textarea name="followup-${comm.counter}" class="form-textarea" placeholder="Contenido del follow-up de LinkedIn"></textarea>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderEmail(comm) {
                return `
                    <div class="communication-block" id="${comm.id}">
                        <div class="communication-header">
                            <span class="communication-type">${comm.type}</span>
                            <button type="button" class="btn btn-danger" onclick="CommunicationManager.remove('${comm.id}')" style="padding: 6px 12px; font-size: 12px;">
                                Eliminar
                            </button>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Asunto</label>
                                <input type="text" name="asunto-${comm.counter}" class="form-input" placeholder="Asunto del email">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Cuerpo del Mail</label>
                                <textarea name="cuerpo-${comm.counter}" class="form-textarea" placeholder="Contenido del email"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Brochures</label>
                                <div class="file-upload-zone">
                                    <input type="file" id="brochures-${comm.counter}" class="file-upload-input" multiple accept=".pdf,.doc,.docx,.jpg,.png">
                                    <label for="brochures-${comm.counter}" class="file-upload-label">
                                        📎 Seleccionar Brochures
                                    </label>
                                </div>
                                <div id="brochures-list-${comm.counter}" class="file-list"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Flyers</label>
                                <div class="file-upload-zone">
                                    <input type="file" id="flyers-${comm.counter}" class="file-upload-input" multiple accept=".pdf,.doc,.docx,.jpg,.png">
                                    <label for="flyers-${comm.counter}" class="file-upload-label">
                                        📎 Seleccionar Flyers
                                    </label>
                                </div>
                                <div id="flyers-list-${comm.counter}" class="file-list"></div>
                            </div>
                        </div>
                    </div>
                `;
            },

            setupEventListeners(communication) {
                if (Utils.isLinkedInCommunication(communication.type)) return;
                
                const brochureInput = document.getElementById(`brochures-${communication.counter}`);
                const flyerInput = document.getElementById(`flyers-${communication.counter}`);
                
                if (brochureInput) {
                    brochureInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files, 'brochures', communication);
                    });
                }
                
                if (flyerInput) {
                    flyerInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files, 'flyers', communication);
                    });
                }
            },

            handleFileUpload(files, type, communication) {
                const filesArray = Array.from(files);
                communication.files[type] = [...communication.files[type], ...filesArray];
                this.updateFileList(communication.counter, type, communication.files[type]);
            },

            updateFileList(counter, type, files) {
                const container = document.getElementById(`${type}-list-${counter}`);
                if (!container || !files.length) return;
                
                container.innerHTML = files.map((file, index) => `
                    <div class="file-item">
                        <span>${file.name}</span>
                        <button type="button" class="file-remove" onclick="CommunicationManager.removeFile('${type}', ${counter}, ${index})">
                            ✕
                        </button>
                    </div>
                `).join('');
            },

            removeFile(type, counter, index) {
                const communication = STATE.communications.find(c => c.counter === counter);
                if (!communication) return;
                
                communication.files[type].splice(index, 1);
                this.updateFileList(counter, type, communication.files[type]);
            },

            loadExistingData(communicationData, counter) {
                debugger;
                const communication = STATE.communications.find(c => c.counter === counter);
                if (!communication) return;

                if (Utils.isLinkedInCommunication(communication.type)) {
                    const primerMensajeField = document.querySelector(`textarea[name="primer-mensaje-${counter}"]`);
                    const followupField = document.querySelector(`textarea[name="followup-${counter}"]`);
                    
                    if (primerMensajeField && communicationData.primerMensaje) {
                        primerMensajeField.value = communicationData.primerMensaje;
                    }
                    if (followupField && communicationData.followUp) {
                        followupField.value = communicationData.followUp;
                    }
                } else {
                    const asuntoField = document.querySelector(`input[name="asunto-${counter}"]`);
                    const cuerpoField = document.querySelector(`textarea[name="cuerpo-${counter}"]`);
                    
                    if (asuntoField && communicationData.asunto) {
                        asuntoField.value = communicationData.asunto;
                    }
                    if (cuerpoField && communicationData.cuerpo) {
                        cuerpoField.value = communicationData.cuerpo;
                    }
                    
                    // Show existing files
                    if (communicationData.brochureFiles?.length) {
                        this.showExistingFiles('brochures', counter, communicationData.brochureFiles);
                    }
                    if (communicationData.flyerFiles?.length) {
                        this.showExistingFiles('flyers', counter, communicationData.flyerFiles);
                    }
                }
            },

            showExistingFiles(type, counter, fileNames) {
                const container = document.getElementById(`${type}-list-${counter}`);
                if (!container || !fileNames.length) return;
                
                const existingHtml = fileNames.map(fileName => `
                    <div class="file-item existing">
                        <span>📎 ${fileName} (guardado)</span>
                        <span style="font-size: 11px; color: var(--accent-green);">EXISTENTE</span>
                    </div>
                `).join('');
                
                container.innerHTML = existingHtml;
            },

            collectData() {
                return STATE.communications.map(comm => {
                    const data = {
                        tipo: comm.type,
                        brochureFiles: comm.files.brochures?.map(f => f.name) || [],
                        flyerFiles: comm.files.flyers?.map(f => f.name) || []
                    };

                    if (Utils.isLinkedInCommunication(comm.type)) {
                        data.primerMensaje = document.querySelector(`textarea[name="primer-mensaje-${comm.counter}"]`)?.value || '';
                        data.followUp = document.querySelector(`textarea[name="followup-${comm.counter}"]`)?.value || '';
                    } else {
                        data.asunto = document.querySelector(`input[name="asunto-${comm.counter}"]`)?.value || '';
                        data.cuerpo = document.querySelector(`textarea[name="cuerpo-${comm.counter}"]`)?.value || '';
                    }

                    return data;
                });
            },

            getAllFiles() {
                return STATE.communications.reduce((allFiles, comm) => {
                    if (!Utils.isLinkedInCommunication(comm.type)) {
                        return allFiles.concat(comm.files.brochures || [], comm.files.flyers || []);
                    }
                    return allFiles;
                }, []);
            }
        };

        // ============================================
        // PIECE MANAGER
        // ============================================
        
        const PieceManager = {
            async load() {
                try {
                    StatusManager.loading('Cargando piezas...');
                    
                    const data = await ApiManager.loadPieces();
                    
                    if (Array.isArray(data)) {
                        STATE.pieces = data.map(piece => ({
                            id: piece.id,
                            tipoPieza: piece.type || 'LHLN',
                            asunto: piece.asunto || 'Sin asunto',
                            fechaCreacion: piece.created ? piece.created.split('T')[0] : new Date().toISOString().split('T')[0],
                            archivos: 0,
                            comunicacionesLHLN: []
                        }));
                    } else if (data?.piezas) {
                        STATE.pieces = data.piezas.map(piece => ({
                            id: piece.id,
                            tipoPieza: piece.type || 'LHLN',
                            asunto: piece.asunto || 'Sin asunto',
                            fechaCreacion: piece.created ? piece.created.split('T')[0] : new Date().toISOString().split('T')[0],
                            archivos: 0,
                            comunicacionesLHLN: []
                        }));
                    }
                    
                    StatusManager.success(`${STATE.pieces.length} piezas cargadas`);
                    this.render();
                    
                } catch (error) {
                    console.error('Error loading pieces:', error);
                    StatusManager.error('Error al cargar las piezas');
                    this.render();
                }
            },

            render() {
                const emptyState = document.getElementById('empty-state-display');
                const table = document.getElementById('pieces-table');
                const tbody = document.getElementById('pieces-tbody');
                const counter = document.getElementById('pieces-counter');

                counter.textContent = `${STATE.pieces.length} pieza${STATE.pieces.length !== 1 ? 's' : ''}`;

                if (STATE.pieces.length === 0) {
                    emptyState.style.display = 'block';
                    table.style.display = 'none';
                    return;
                }

                emptyState.style.display = 'none';
                table.style.display = 'table';

                tbody.innerHTML = STATE.pieces.map(piece => `
                    <tr>
                        <td><strong>${piece.tipoPieza}</strong></td>
                        <td>${piece.asunto}</td>
                        <td>
                            <span style="background: var(--accent-blue); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                ${piece.comunicacionesLHLN?.length || 0} comunicaciones
                            </span>
                        </td>
                        <td>
                            <span style="background: var(--text-secondary); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                ${piece.archivos} archivos
                            </span>
                        </td>
                        <td>${Utils.formatDate(piece.fechaCreacion)}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-warning" onclick="PieceManager.edit(${piece.id})">
                                    Editar
                                </button>
                                <button class="btn btn-danger" onclick="PieceManager.delete(${piece.id})">
                                    Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            },

            showCreateForm() {
                //STATE.editingPieceId = 2;
                document.getElementById('form-modal-title').textContent = 'Nueva Pieza';
                document.getElementById('piece-form').reset();
                document.getElementById('campaign-name-input').value = STATE.campaignName;
                
                CommunicationManager.clear();
                MessageManager.hideAll();
                
                this.resetSubmitButtonListener();
                
                document.getElementById('piece-form-modal').classList.add('active');
                document.getElementById('piece-form-modal').scrollIntoView({ behavior: 'smooth', block: 'start' });
            },

            resetSubmitButtonListener() {
                const submitButton = document.querySelector('.submit');
                if (submitButton) {
                    // Remove existing event listeners by cloning the button
                    const newSubmitButton = submitButton.cloneNode(true);
                    submitButton.parentNode.replaceChild(newSubmitButton, submitButton);
                }
            },

            async edit(pieceId) {
                console.log("[v0] Starting edit for piece ID:", pieceId); // Added debug logging
                try {
                    STATE.editingPieceId = pieceId;
                    console.log("[v0] Set STATE.editingPieceId to:", STATE.editingPieceId); // Added debug logging
                    document.getElementById('form-modal-title').textContent = 'Editar Pieza';
                    
                    this.showCreateForm();
                    
                    this.updateSubmitButtonListener();
                    
                    StatusManager.loading('Cargando datos de la pieza...');
                    const pieceDetails = await ApiManager.loadPieceDetails(pieceId);
                    
                    await this.fillFormWithDetails(pieceDetails);
                    StatusManager.success('Datos cargados exitosamente');
                    
                } catch (error) {
                    console.error('Error editing piece:', error);
                    StatusManager.error('Error al cargar los datos de la pieza');
                    MessageManager.showError(`Error: ${error.message}`);
                }
            },

            updateSubmitButtonListener() {
                const submitButton = document.querySelector('.submit');
                if (submitButton) {
                    // Remove existing event listeners by cloning the button
                    const newSubmitButton = submitButton.cloneNode(true);
                    submitButton.parentNode.replaceChild(newSubmitButton, submitButton);
                    
                    newSubmitButton.addEventListener('click', async (e) => {
                        e.preventDefault();
                        console.log("[v0] Edit button clicked, STATE.editingPieceId:", STATE.editingPieceId); // Added debug logging
                        const pieceData = PieceManager.collectFormData();
                        console.log("[v0] Collected form data:", pieceData); // Added debug logging
                        await PieceManager.editPiece(pieceData);
                    });
                }
            },

            async editPiece(pieceData) {
                try {
                    console.log("[v0] editPiece called with data:", pieceData); // Added debug logging
                    console.log("[v0] STATE.editingPieceId:", STATE.editingPieceId); // Added debug logging
                    
                    StatusManager.loading('Actualizando pieza...');
                    
                    if (!STATE.editingPieceId) {
                        throw new Error('ID de pieza no encontrado para edición');
                    }
                    
                    const totalFiles = CommunicationManager.getAllFiles().length;
                    const enhancedPieceData = {
                        ...pieceData,
                        totalArchivos: totalFiles,
                        tipoPieza: this.getMainType(pieceData.comunicacionesLHLN),
                        esNuevaPieza: false,
                        id: STATE.editingPieceId // Use STATE.editingPieceId directly
                    };

                    console.log("[v0] Enhanced piece data:", enhancedPieceData); // Added debug logging

                    // Use edit webhook
                    await ApiManager.editPiece(enhancedPieceData);

                    // Save files if any
                    const files = CommunicationManager.getAllFiles();
                    if (files.length > 0) {
                        await this.saveFiles(enhancedPieceData.id, files);
                    }

                    // Update local state
                    this.updateLocalState(enhancedPieceData);
                    
                    StatusManager.success('Pieza actualizada exitosamente');
                    MessageManager.showSuccess(`Pieza actualizada con ${totalFiles} archivos`);
                    
                    this.render();
                    this.hideForm();
                    
                } catch (error) {
                    console.error('Error updating piece:', error);
                    StatusManager.error('Error al actualizar la pieza');
                    MessageManager.showError(`Error: ${error.message}`);
                }
            },

            async fillFormWithDetails(pieceDetails) {
                debugger;
                const communications = pieceDetails;
                
                if (!Array.isArray(communications)) {
                    console.warn('Communications is not an array:', communications);
                    return;
                }
                
                for (const commData of communications) {
                    if (!commData.type) continue;
                    
                    // Add communication to form
                    const selector = document.getElementById('communication-type-selector');
                    selector.value = commData.type;
                    CommunicationManager.add();
                    
                    // Wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                    // Load data into the new communication
                    CommunicationManager.loadExistingData(commData, STATE.communicationCounter);
                }
            },

            async save(pieceData) {
                try {
                    StatusManager.loading('Guardando pieza...');
                    
                    const totalFiles = CommunicationManager.getAllFiles().length;
                    const enhancedPieceData = {
                        ...pieceData,
                        totalArchivos: totalFiles,
                        tipoPieza: this.getMainType(pieceData.comunicacionesLHLN),
                        esNuevaPieza: !STATE.editingPieceId
                    };

                    if (STATE.editingPieceId) {
                        // Editing existing piece - use edit webhook
                        await ApiManager.editPiece(enhancedPieceData);
                    } else {
                        // Creating new piece - use save webhook
                        await ApiManager.savePiece(enhancedPieceData);
                    }

                    // Save files if any
                    const files = CommunicationManager.getAllFiles();
                    if (files.length > 0) {
                        await this.saveFiles(pieceData.id, files);
                    }

                    // Update local state
                    this.updateLocalState(enhancedPieceData);
                    
                    StatusManager.success(`Pieza ${STATE.editingPieceId ? 'actualizada' : 'creada'} exitosamente`);
                    MessageManager.showSuccess(`Pieza guardada con ${totalFiles} archivos`);
                    
                    this.render();
                    this.hideForm();
                    
                } catch (error) {
                    console.error('Error saving piece:', error);
                    StatusManager.error('Error al guardar la pieza');
                    MessageManager.showError(`Error: ${error.message}`);
                }
            },

            async saveFiles(pieceId, files) {
                const formData = new FormData();
                formData.append('piezaId', pieceId);
                formData.append('campana', STATE.campaignName);
                formData.append('campaignId', STATE.campaignId);
                
                files.forEach((file, index) => {
                    if (file?.name) {
                        const extension = Utils.getFileExtension(file);
                        const fileName = `archivo_${index}${extension}`;
                        formData.append(`archivo_${index}`, file, fileName);
                    }
                });
                
                await ApiManager.saveFiles(formData);
            },

            updateLocalState(pieceData) {
                const pieceForDisplay = {
                    ...pieceData,
                    archivos: pieceData.totalArchivos
                };
                
                if (STATE.editingPieceId) {
                    const index = STATE.pieces.findIndex(p => p.id === STATE.editingPieceId);
                    if (index !== -1) {
                        STATE.pieces[index] = pieceForDisplay;
                    }
                } else {
                    STATE.pieces.push(pieceForDisplay);
                }
            },

            getMainType(communications) {
                if (!communications?.length) return 'Sin comunicaciones';
                
                const lhln = communications.find(c => c.tipo.startsWith('LHLN'));
                if (lhln) return lhln.tipo;
                
                const email = communications.find(c => c.tipo.includes('Mail'));
                if (email) return email.tipo;
                
                return communications[0].tipo;
            },

            delete(pieceId) {
                const piece = STATE.pieces.find(p => p.id === pieceId);
                if (!piece) return;
                
                if (confirm(`¿Eliminar la pieza "${piece.tipoPieza}"?`)) {
                    STATE.pieces = STATE.pieces.filter(p => p.id !== pieceId);
                    this.render();
                    StatusManager.success('Pieza eliminada');
                }
            },

            collectFormData() {
                const formData = new FormData(document.getElementById('piece-form'));
                const communications = CommunicationManager.collectData();
                const files = CommunicationManager.getAllFiles();
                
                return {
                    id: STATE.editingPieceId , // Keep this for new pieces
                    campana: formData.get('campana'),
                    comunicacionesLHLN: communications[0],
                    archivos: files,
                    fechaCreacion: new Date().toISOString().split('T')[0],
                    campaignId: STATE.campaignId
                };
            },

            hideForm() {
                document.getElementById('piece-form-modal').classList.remove('active');
                STATE.editingPieceId = 0;
                CommunicationManager.clear();
                MessageManager.hideAll();
            }
        };

        // ============================================
        // APP INITIALIZATION
        // ============================================
        
        const App = {
            init() {
                this.loadCampaignInfo();
                this.setupEventListeners();
                PieceManager.load();
            },

            loadCampaignInfo() {
                const urlParams = new URLSearchParams(window.location.search);
                STATE.campaignId = urlParams.get('campaña');
                STATE.campaignName = urlParams.get('nombre') || 'Sin nombre';
                
                document.getElementById('campaign-display').textContent = `Campaña: ${STATE.campaignName}`;
                document.getElementById('campaign-name-input').value = STATE.campaignName;
            },

            setupEventListeners() {
                const form = document.getElementById('piece-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const pieceData = PieceManager.collectFormData();
                    await PieceManager.save(pieceData);
                });
            }
        };

        // ============================================
        // START APPLICATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Make functions globally available
        window.PieceManager = PieceManager;
        window.CommunicationManager = CommunicationManager;
    </script>
</body>
</html>
